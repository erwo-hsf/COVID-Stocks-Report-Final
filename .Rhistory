bntx <- full_dates |>
left_join(bntx_raw, by="Date") |>
as_tsibble(index = Date)
# define the training dataset (pre-COVID period)
bntx_train <- bntx |> filter(Date < "2020-03-01")
# fit ARIMA model on training data
bntx_fit <- bntx_train |> model(ARIMA(Close))
# generate forecast for three years
bntx_fc <- bntx_fit |> forecast(h="3 years")
# plot forecast vs actual prices
bntx_fc |>
autoplot(bntx) +
labs(
title="BioNTech (BNTX) — ARIMA Forecast vs Actual",
subtitle="Model trained on data before March 2020",
x="Date",
y="Close Price (USD)"
)
# load data
getSymbols("SHEL", src="yahoo", from="2019-01-01", to="2023-12-31")
# convert Shell xts object into a tidy data frame
shel_raw <- as.data.frame(SHEL) |>
rownames_to_column("Date") |>
mutate(Date = as.Date(Date),
Close = as.numeric(SHEL[,4])) |>
select(Date, Close)
# create a complete daily date sequence
full_dates <- tibble(
Date = seq(as.Date("2019-01-01"),
as.Date("2023-12-31"),
by="day")
)
# merge full calendar with observed prices and convert to tsibble
shel <- full_dates |>
left_join(shel_raw, by="Date") |>
as_tsibble(index = Date)
# define the training dataset (pre-COVID period)
shel_train <- shel |> filter(Date < "2020-03-01")
# fit ARIMA model on training data
shel_fit <- shel_train |> model(ARIMA(Close))
# generate forecast for three years
shel_fc <- shel_fit |> forecast(h="3 years")
# plot forecast vs actual prices
shel_fc |>
autoplot(shel) +
labs(
title="Shell (SHEL) ARIMA Forecast vs Actual",
subtitle="Model trained on data before March 2020",
x="Date",
y="Close Price (USD)"
)
#continuous forecasts
library(dplyr)
library(tibble)
library(tidyr)
library(tsibble)
library(fable)
library(feasts)
library(ggplot2)
# Apple correct forecast
# Apple: Close
aapl_raw <- closing_table %>%
transmute(Date = as.Date(Date), Close = Apple)
# Full daily calendar
aapl <- tibble(Date = seq(as.Date("2019-01-01"), as.Date("2023-12-31"), by = "day")) %>%
left_join(aapl_raw, by = "Date") %>%
as_tsibble(index = Date)
# ARIMA: train pre-COVID
aapl_fit <- aapl %>%
filter(Date < as.Date("2020-03-01")) %>%
model(arima = ARIMA(Close))
aapl_fc <- aapl_fit %>% forecast(h = "3 years")
# Forward fill NAs for visualization only
aapl_plot <- aapl %>%
as_tibble() %>%
arrange(Date) %>%
fill(Close, .direction = "down") %>%
as_tsibble(index = Date)
# Plot
aapl_fc %>%
autoplot(aapl_plot) +
labs(
title = "Apple (AAPL) — ARIMA Forecast vs Actual",
subtitle = "Model trained on data before March 2020",
y = "Close Price (USD)",
x = "Date"
)
# Lufthansa: Close
lha_raw <- closing_table %>%
transmute(Date = as.Date(Date), Close = Lufthansa)
# Full daily calendar
lha <- tibble(Date = seq(as.Date("2019-01-01"), as.Date("2023-12-31"), by = "day")) %>%
left_join(lha_raw, by = "Date") %>%
as_tsibble(index = Date)
# ARIMA: train pre-COVID
lha_fit <- lha %>%
filter(Date < as.Date("2020-03-01")) %>%
model(arima = ARIMA(Close))
lha_fc <- lha_fit %>% forecast(h = "3 years")
# Forward fill NAs for visualization only
lha_plot <- lha %>%
as_tibble() %>%
arrange(Date) %>%
fill(Close, .direction = "down") %>%
as_tsibble(index = Date)
# Plot
lha_fc %>%
autoplot(lha_plot) +
labs(
title = "Lufthansa (LHA.DE) — ARIMA Forecast vs Actual",
subtitle = "Model trained on data before March 2020",
y = "Close Price (EUR)",
x = "Date"
)
# BioNTech: Close
bntx_raw <- closing_table %>%
transmute(Date = as.Date(Date), Close = BioNTech)
# Full daily calendar
bntx <- tibble(Date = seq(as.Date("2019-01-01"), as.Date("2023-12-31"), by = "day")) %>%
left_join(bntx_raw, by = "Date") %>%
as_tsibble(index = Date)
# ARIMA: train pre-COVID
bntx_fit <- bntx %>%
filter(Date < as.Date("2020-03-01")) %>%
model(arima = ARIMA(Close))
bntx_fc <- bntx_fit %>% forecast(h = "3 years")
# Forward fill NAs for visualization only
bntx_plot <- bntx %>%
as_tibble() %>%
arrange(Date) %>%
fill(Close, .direction = "down") %>%
as_tsibble(index = Date)
# Plot
bntx_fc %>%
autoplot(bntx_plot) +
labs(
title = "BioNTech (BNTX) — ARIMA Forecast vs Actual",
subtitle = "Model trained on data before March 2020",
y = "Close Price (USD)",
x = "Date"
)
# Shell: Close
shel_raw <- closing_table %>%
transmute(Date = as.Date(Date), Close = Shell)
# Full daily calendar
shel <- tibble(Date = seq(as.Date("2019-01-01"), as.Date("2023-12-31"), by = "day")) %>%
left_join(shel_raw, by = "Date") %>%
as_tsibble(index = Date)
# ARIMA: train pre-COVID
shel_fit <- shel %>%
filter(Date < as.Date("2020-03-01")) %>%
model(arima = ARIMA(Close))
shel_fc <- shel_fit %>% forecast(h = "3 years")
# Forward fill NAs for visualization only
shel_plot <- shel %>%
as_tibble() %>%
arrange(Date) %>%
fill(Close, .direction = "down") %>%
as_tsibble(index = Date)
# Plot
shel_fc %>%
autoplot(shel_plot) +
labs(
title = "Shell (SHEL) ARIMA Forecast vs Actual",
subtitle = "Model trained on data before March 2020",
y = "Close Price (USD)",
x = "Date"
)
#Stocks detailed ADF test
#load package
library(urca)
# ADF test on closing prices
adf_test <- function(x, name) {
close_prices <- na.omit(as.numeric(Cl(x)))
test <- ur.df(close_prices, type = "drift", selectlags = "AIC")
cat("\nADF test for", name, "\n")
print(summary(test))
}
#ADF tests
adf_test(AAPL,   "Apple")
adf_test(BNTX,   "BioNTech")
adf_test(`LHA.DE`, "Lufthansa")
adf_test(SHEL,   "Shell")
#load package
library(tseries)
#ADF tests
adf.test(na.omit(as.numeric(AAPL_cl)))
adf.test(na.omit(as.numeric(BNTX_cl)))
adf.test(na.omit(as.numeric(LHA_cl)))
adf.test(na.omit(as.numeric(SHEL_cl)))
#load package
library(tseries)
#ADF test
adf.test(na.omit(world$confirmed))
#load packages
library(dplyr)
library(tibble)
library(ggplot2)
# Create a function to plot first differences of closing prices
plot_first_diff_cl <- function(cl, name) {
# Build a data frame with Date and Close values
df_diff <- tibble(
Date  = as.Date(time(cl)),
Close = as.numeric(cl)
) %>%
# Restrict the sample period to 2019–2023
filter(Date >= as.Date("2019-01-01"),
Date <= as.Date("2023-12-31")) %>%
# Compute first differences
mutate(Diff = Close - lag(Close)) %>%
# Remove missing values
filter(!is.na(Diff))
# Plot the first differences over time
ggplot(df_diff, aes(x = Date, y = Diff)) +
geom_line(color = "black", linewidth = 0.4) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(
title = paste(name, "– First Differences"),
subtitle = "Daily price changes",
x = "Date",
y = "First Difference"
) +
theme_minimal()
}
# Plot first differences for each stock
plot_first_diff_cl(AAPL_cl, "Apple (AAPL)")
plot_first_diff_cl(BNTX_cl, "BioNTech (BNTX)")
plot_first_diff_cl(LHA_cl,  "Lufthansa (LHA.DE)")
plot_first_diff_cl(SHEL_cl, "Shell (SHEL)")
# Stocks
library(tseries)
# Create a function to compute log returns and run an ADF test
get_log_returns <- function(cl, name) {
# Compute log returns from closing prices
r <- diff(log(na.omit(as.numeric(cl))))  # log returns
# Run ADF test on log returns
cat("\nADF Test for", name, "\n")
print(adf.test(r))
# Return log return series
r
}
# Compute log returns for each stock
ret_AAPL <- get_log_returns(AAPL_cl, "Apple (AAPL)")
ret_BNTX <- get_log_returns(BNTX_cl, "BioNTech (BNTX)")
ret_LHA  <- get_log_returns(LHA_cl,  "Lufthansa (LHA.DE)")
ret_SHEL <- get_log_returns(SHEL_cl, "Shell (SHEL)")
# covid log returns
library(tseries)
# Create a function to compute a stationary COVID shock series and run an ADF test
get_covid_shock <- function(x, name = "COVID confirmed") {
# Compute log-growth differences using log1p to handle zero values
r <- diff(log1p(na.omit(x)))
# Run ADF test on the transformed COVID series
cat("\nADF Test for", name, "\n")
print(adf.test(r))
# Return COVID shock series
r
}
# Compute COVID shock series from global confirmed cases
covid_shock <- get_covid_shock(world$confirmed, "COVID confirmed cases")
#Granger causality tests
#load packages
library(lmtest)
library(dplyr)
library(zoo)
# lufthansa Granger
# create Lufthansa data frame with Date and LogReturn
ret_LHA_df <- tibble(
Date = as.Date(zoo::index(LHA_cl))[-1],
LogReturn = as.numeric(ret_LHA)
) %>%
# compute rolling volatility
mutate(Volatility = zoo::rollapply(LogReturn, 21, sd, fill = NA, align = "right"))
# merge Lufthansa volatility with COVID shock series by date
granger_vol_LHA <- ret_LHA_df %>%
select(Date, Volatility) %>%
left_join(
covid_world %>% select(date, covid_shock),
by = c("Date" = "date")
) %>%
# remove missing values and sort chronologically
na.omit() %>%
arrange(Date)
# run Granger causality test
grangertest(
Volatility ~ covid_shock,
order = 5,
data = granger_vol_LHA
)
#load packages
library(dplyr)
library(tibble)
library(ggplot2)
# Create a function to plot first differences of closing prices
plot_first_diff_cl <- function(cl, name) {
# Build a data frame with Date and Close values
df_diff <- tibble(
Date  = as.Date(time(cl)),
Close = as.numeric(cl)
) %>%
# Restrict the sample period to 2019–2023
filter(Date >= as.Date("2019-01-01"),
Date <= as.Date("2023-12-31")) %>%
# Compute first differences
mutate(Diff = Close - lag(Close)) %>%
# Remove missing values
filter(!is.na(Diff))
# Plot the first differences over time
ggplot(df_diff, aes(x = Date, y = Diff)) +
geom_line(color = "black", linewidth = 0.4) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(
title = paste(name, "– First Differences"),
subtitle = "Daily price changes",
x = "Date",
y = "First Difference"
) +
theme_minimal()
}
# Plot first differences for each stock
plot_first_diff_cl(AAPL_cl, "Apple (AAPL)")
plot_first_diff_cl(BNTX_cl, "BioNTech (BNTX)")
plot_first_diff_cl(LHA_cl,  "Lufthansa (LHA.DE)")
plot_first_diff_cl(SHEL_cl, "Shell (SHEL)")
# Stocks
library(tseries)
# Create a function to compute log returns and run an ADF test
get_log_returns <- function(cl, name) {
# Compute log returns from closing prices
r <- diff(log(na.omit(as.numeric(cl))))  # log returns
# Run ADF test on log returns
cat("\nADF Test for", name, "\n")
print(adf.test(r))
# Return log return series
r
}
# Compute log returns for each stock
ret_AAPL <- get_log_returns(AAPL_cl, "Apple (AAPL)")
ret_BNTX <- get_log_returns(BNTX_cl, "BioNTech (BNTX)")
ret_LHA  <- get_log_returns(LHA_cl,  "Lufthansa (LHA.DE)")
ret_SHEL <- get_log_returns(SHEL_cl, "Shell (SHEL)")
# covid log returns
library(tseries)
# Create a function to compute a stationary COVID shock series and run an ADF test
get_covid_shock <- function(x, name = "COVID confirmed") {
# Compute log-growth differences using log1p to handle zero values
r <- diff(log1p(na.omit(x)))
# Run ADF test on the transformed COVID series
cat("\nADF Test for", name, "\n")
print(adf.test(r))
# Return COVID shock series
r
}
# Compute COVID shock series from global confirmed cases
covid_shock <- get_covid_shock(world$confirmed, "COVID confirmed cases")
#Granger causality tests
#load packages
library(lmtest)
library(dplyr)
library(zoo)
# lufthansa Granger
# create Lufthansa data frame with Date and LogReturn
ret_LHA_df <- tibble(
Date = as.Date(zoo::index(LHA_cl))[-1],
LogReturn = as.numeric(ret_LHA)
) %>%
# compute rolling volatility
mutate(Volatility = zoo::rollapply(LogReturn, 21, sd, fill = NA, align = "right"))
# merge Lufthansa volatility with COVID shock series by date
granger_vol_LHA <- ret_LHA_df %>%
select(Date, Volatility) %>%
left_join(
covid_world %>% select(date, covid_shock),
by = c("Date" = "date")
) %>%
# remove missing values and sort chronologically
na.omit() %>%
arrange(Date)
View(world)
# Granger causality tests for all stocks (same structure as Lufthansa)
library(lmtest)
library(dplyr)
library(zoo)
library(tibble)
# 1) Add covid_shock to world
world <- world %>%
arrange(date) %>%
mutate(covid_shock = c(NA, diff(log1p(confirmed))))
# Helper function: build volatility DF for a return series
make_vol_df <- function(cl_xts, ret_series) {
tibble(
Date = as.Date(zoo::index(cl_xts))[-1],
LogReturn = as.numeric(ret_series)
) %>%
mutate(
Volatility = zoo::rollapply(LogReturn, 21, sd, fill = NA, align = "right")
) %>%
select(Date, Volatility)
}
# Helper function: merge with covid_shock + run granger
run_granger <- function(vol_df, world_df, stock_name, lag_order = 5) {
granger_data <- vol_df %>%
inner_join(
world_df %>% select(date, covid_shock),
by = c("Date" = "date")
) %>%
drop_na() %>%
arrange(Date)
cat("\n============================\n")
cat("Granger Test for", stock_name, "\n")
cat("============================\n")
print(grangertest(Volatility ~ covid_shock,
order = lag_order,
data = granger_data))
}
# 2) Lufthansa
vol_LHA <- make_vol_df(LHA_cl, ret_LHA)
run_granger(vol_LHA, world, "Lufthansa (LHA.DE)")
# 3) Apple
vol_AAPL <- make_vol_df(AAPL_cl, ret_AAPL)
run_granger(vol_AAPL, world, "Apple (AAPL)")
# 4) BioNTech
vol_BNTX <- make_vol_df(BNTX_cl, ret_BNTX)
run_granger(vol_BNTX, world, "BioNTech (BNTX)")
# 5) Shell
vol_SHEL <- make_vol_df(SHEL_cl, ret_SHEL)
run_granger(vol_SHEL, world, "Shell (SHEL)")
#regression
#load packages
library(dplyr)
library(lmtest)
library(sandwich)
# Lufthansa regression (Volatility explained by COVID shock)
model_LHA <- lm(Volatility ~ covid_shock, data = granger_vol_LHA)
# Lufthansa regression (Volatility explained by COVID shock)
model_LHA <- lm(Volatility ~ covid_shock, data = vol_LHA)
# Lufthansa regression (Volatility explained by COVID shock)
model_LHA <- lm(Volatility ~ covid_shock, data = vol_LHA)
summary(model_LHA)
View(aapl_df)
# -----------------------------
# Regression-Setup (NEU)
# -----------------------------
library(dplyr)
library(lmtest)
library(sandwich)
# Helper: baue exakt den gleichen Merge wie in run_granger()
make_reg_df <- function(vol_df, world_df) {
vol_df %>%
inner_join(
world_df %>% select(date, covid_shock),
by = c("Date" = "date")
) %>%
drop_na() %>%
arrange(Date)
}
# Datensätze für Regression erzeugen
granger_vol_LHA  <- make_reg_df(vol_LHA,  world)
granger_vol_AAPL <- make_reg_df(vol_AAPL, world)
granger_vol_BNTX <- make_reg_df(vol_BNTX, world)
granger_vol_SHEL <- make_reg_df(vol_SHEL, world)
# -----------------------------
# Regressionen (wie gehabt)
# -----------------------------
model_LHA <- lm(Volatility ~ covid_shock, data = granger_vol_LHA)
summary(model_LHA)
coeftest(model_LHA, vcov = NeweyWest(model_LHA))
model_AAPL <- lm(Volatility ~ covid_shock, data = granger_vol_AAPL)
summary(model_AAPL)
coeftest(model_AAPL, vcov = NeweyWest(model_AAPL))
model_BNTX <- lm(Volatility ~ covid_shock, data = granger_vol_BNTX)
summary(model_BNTX)
coeftest(model_BNTX, vcov = NeweyWest(model_BNTX))
model_SHEL <- lm(Volatility ~ covid_shock, data = granger_vol_SHEL)
summary(model_SHEL)
coeftest(model_SHEL, vcov = NeweyWest(model_SHEL))
# Regression for all stocks
# Load packages
library(dplyr)
library(lmtest)
library(sandwich)
# build regression DF (same merge as in run_granger)
make_reg_df <- function(vol_df, world_df) {
vol_df %>%
inner_join(
world_df %>% select(date, covid_shock),
by = c("Date" = "date")
) %>%
drop_na() %>%
arrange(Date)
}
# run regression + Newey-West output
run_regression <- function(vol_df, world_df, stock_name) {
reg_data <- make_reg_df(vol_df, world_df)
cat("\n============================\n")
cat("Regression for", stock_name, "\n")
cat("============================\n")
model <- lm(Volatility ~ covid_shock, data = reg_data)
print(summary(model))
print(coeftest(model, vcov = NeweyWest(model)))
return(invisible(model))
}
# Lufthansa regression
model_LHA <- run_regression(vol_LHA, world, "Lufthansa (LHA.DE)")
# Apple regression
model_AAPL <- run_regression(vol_AAPL, world, "Apple (AAPL)")
# BioNTech regression
model_BNTX <- run_regression(vol_BNTX, world, "BioNTech (BNTX)")
# Shell regression
model_SHEL <- run_regression(vol_SHEL, world, "Shell (SHEL)")
View(aapl_fit)
View(aapl_fc)
